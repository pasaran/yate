// ----------------------------------------------------------------------------------------------------------------- //
// main
// ----------------------------------------------------------------------------------------------------------------- //

main

    Yater.modules['%Module'] = function(yater, root) {

        var vars = new Yater.Vars();

        %Stylesheet

        return matcher;

    };



// ----------------------------------------------------------------------------------------------------------------- //
// stylesheet
// ----------------------------------------------------------------------------------------------------------------- //

// На первое время, шаблоны (и соответственно matcher) выводятся только на верхнем уровне.

stylesheet

    %Block#defs

    %Block.Templates#defs

    %Block#matcher



// ----------------------------------------------------------------------------------------------------------------- //
// defs: template, function_, key, var_
// ----------------------------------------------------------------------------------------------------------------- //

// template.

template #defs

    // match %Selector#yate %Mode#yate
    var t%Tid = {
        jpath: %Selector#selector_ref,
        body: %.
    };


template

    function(c%Cid, a%Rid, index, count%Args) {
        %Args#defaults
        %.#prologue

        %Body#output

        return r%Rid;
    }

//template #prologue [ %type() == 'array' ]
//
//    var r%Rid = [];
//
//template #prologue [ %type() == 'object' ]
//
//    var r%Rid = {};

template #prologue

    var r%Rid = '';


// ----------------------------------------------------------------------------------------------------------------- //

// function_

function_ #defs

    // %Name
    function f%Fid(c%Cid, a%Rid, index, count%Args) {
        %Args#defaults
        %.#prologue

        %Body#output

        return r%Rid;
    }

function_ #prologue [ %type() == 'nodeset' ]

    var r%Rid = [];

function_ #prologue [ %type() == 'boolean' ]

    var r%Rid = false;

function_ #prologue

    var r%Rid = '';


// ----------------------------------------------------------------------------------------------------------------- //
// block and body
// ----------------------------------------------------------------------------------------------------------------- //

body #output

    %Block#output

block#output

    %.#defs

    %Exprs#output

* #prologue [ %type() == 'nodeset' ]

    var r%Rid = [];

* #prologue [ %type() == 'boolean' ]

    var r%Rid = false;

* #prologue

    var r%Rid = '';
    var a%Rid = { attrs: {} };





// ----------------------------------------------------------------------------------------------------------------- //

var_ #defs [ %Value.inline() && %Lazy ]

    vars.add("v%Vid", function(c0) { return %Value; });

var_ #defs [ %Value.inline() ]

    var v%Vid = %Value;

var_ #defs [ %Value.type() == 'attr' && %Lazy ]

    vars.add("v%Vid", function(c0) {
        %Value#prologue
        %Value#output
        return a%{Value.Rid}.attrs;
    });

var_ #defs [ %Value.type() == 'attr' ]

    %Value#prologue
    %Value#output
    var v%Vid = a%{Value.Rid}.attrs;

var_ #defs [ %Lazy ]

    vars.add("v%Vid", function(c0) {
        %Value#prologue
        %Value#output
        return r%Value.Rid;
    });

var_ #defs

    %Value#prologue
    %Value#output
    var v%Vid = r%Value.Rid;

// ----------------------------------------------------------------------------------------------------------------- //

key #defs

    var k%{Kid}_nodes;
    var k%{Kid}_values = {};
    var k%{Kid}_get = function(key) {
        var value = k%{Kid}_values[key];
        if (!value) {
            var c%Cid = k%{Kid}_nodes[key];
            if (c%Cid) {
                %Body.Block#prologue
                %Body#output
                value = r%Body.Block.Rid;
            }
            if (value) {
                k%{Kid}_values[key] = value;
            }
        }
        return value || [];
    };
    var k%{Kid} = function(key) {
        if (!k%{Kid}_nodes) {
            var c%Cid = root[0]; // FIXME: Сделать root[0] отдельной переменной.
            var nodes = %Nodes;
            k%{Kid}_nodes = {};
            for (var i = 0, l = nodes.length; i < l; i++) {
                var c%Use.Cid = nodes[i];
                var useNodes = %Use;
                for (var j = 0, m = useNodes.length; j < m; j++) {
                    k%{Kid}_nodes[ yater.nodeValue(useNodes[j]) ] = c%Use.Cid;
                }
            }

            k%{Kid} = k%{Kid}_get;
        }

        return k%{Kid}_get(key);
    };



// ----------------------------------------------------------------------------------------------------------------- //
// block expressions
// ----------------------------------------------------------------------------------------------------------------- //

if_ #output [ %Else ]

    if (%Condition) {
        %Then#output
    } else {
        %Else#output
    }

if_ #output

    if (%Condition) {
        %Then#output
    }

// ----------------------------------------------------------------------------------------------------------------- //

for_ #output

    var items%Cid = %Selector;
    for (var i%Cid = 0, l%Cid = items%{Cid}.length; i%Cid < l%Cid; i%Cid++) {
        var c%Body.Cid = items%Cid[ i%Cid ];
        %Body#output
    }

// ----------------------------------------------------------------------------------------------------------------- //

apply #output [ !%Args.empty() ]

    r%Rid += yater.applyValue(%Expr, %Mode#string, a%Rid);

apply #output

    r%Rid += yater.applyValue(%Expr, %Mode#string, a%Rid, %Args);

template_mode #string

    '%Value'

// ----------------------------------------------------------------------------------------------------------------- //

xml_attr #open

    '%Name': %Value

xml_line #output

    r%Rid += %.#content;

// ----------------------------------------------------------------------------------------------------------------- //

// FIXME: Закэшировать a0.attrs в отдельную переменную.
attr #output [ %Value.inline() && %Op == '+=' ]
    a%{Rid}.attrs['%Name'] = (a%{Rid}.attrs['%Name'] || '') + %Value;

attr #output [ %Value.inline() ]
    a%{Rid}.attrs['%Name'] %Op %Value;

attr #output [ %Op == '+=' ]

    %Value#prologue
    %Value#output
    a%{Rid}.attrs['%Name'] = (a%{Rid}.attrs['%Name'] || '') + r%Value.Rid;

attr #output

    %Value#prologue
    %Value#output
    a%{Rid}.attrs['%Name'] %Op r%Value.Rid;

attrs_close #output
    r%Rid += yater.closeAttrs(a%Rid);

attrs_open#output

    a%{Rid}.attrs = {
        %Attrs#open
    };
    a%{Rid}.start = '%Name';

// ----------------------------------------------------------------------------------------------------------------- //

scalar#output

    %Block#output



// ----------------------------------------------------------------------------------------------------------------- //
// Selectors: jpath and root.
// ----------------------------------------------------------------------------------------------------------------- //

root

    root

// Для jpath выводим имя его переменной, для root -- null.

root #selector_ref

    null

jpath #selector_ref

    j%Jid

jpath [ %yate() == '.' ]

    [ c%Cid ]

jpath

    yater.select(j%Jid, c%Cid)

jpath_predicate #defs

    // %Key
    function p%Pid(c%Cid, index, count) {
        return %Expr;
    };

jpath #defs

    var j%Jid = %.#compiled; // %Key

jpath #compiled

    [ %Steps#compiled ]

jpath_nametest #compiled

    0, "%Name"

jpath_dots #compiled

    1, %Length

jpath_predicate #compiled [ %isLocal() ]

    2, p%Pid

jpath_predicate #compiled

    3, %Expr

// FIXME: Переименовать в inline_filter
jpath_filter

    yater.select(j%JPath.Jid, %Expr)



// ----------------------------------------------------------------------------------------------------------------- //

arglist_item
    , v%Vid

arglist_item #defaults [ %Default ]
    v%Vid = v%Vid || %Default;



// ----------------------------------------------------------------------------------------------------------------- //
// inline expressions
// ----------------------------------------------------------------------------------------------------------------- //

inline_var #inline_output [ %type() == 'attr' && %def.Lazy ]
    yater.copyAttrs( a%{Rid}.attrs, vars.get("v%def.Vid", c%Cid) );

inline_var #inline_output [ %type() == 'attr' ]
    yater.copyAttrs(a%{Rid}.attrs, v%def.Vid);

* #inline_output [ ( %type() == 'nodeset' || %type() == 'boolean' ) && !%AsType ]

    r%Rid = %.;

* #inline_output

    r%Rid += %.;

inline_or
    %Left || %Right

inline_and
    %Left && %Right

inline_not
    !%Left

inline_eq
    %Left %Op %Right

inline_rel
    %Left %Op %Right

inline_add
    %Left %Op %Right

inline_mul
    %Left %Op %Right

inline_unary
    -%Expr

inline_union
    (%Left).concat(%Right)

inline_complex
    (%Expr)

// ----------------------------------------------------------------------------------------------------------------- //

inline_function [ %External ]
    (Yater.externals['%Name'])(%Args)

inline_function [ %Kid !== '' ]
    k%Kid(%Args, root)

inline_function [ %Fid !== '' && !%Args.empty() ]
    f%Fid(c%Cid, a%Rid, index, count, %Args)

inline_function [ %Fid !== '' ]
    f%Fid(c%Cid, a%Rid, index, count)

// ----------------------------------------------------------------------------------------------------------------- //

// FIXME: Заменить на inline_function_true и т.д.

inline_function [ %Name == 'true' ]
    true

inline_function [ %Name == 'false' ]
    false

inline_function [ %Name == 'name' ]
    c%{Cid}.name

inline_function [ %Name == 'index' ]
    index

inline_function [ %Name == 'count' ]
    count

inline_function [ %Name == 'slice' ]
    yater.slice(%Args)

inline_function [ %Name == 'html' ]
    %Args

// ----------------------------------------------------------------------------------------------------------------- //

inline_var [ %def.Lazy ]
    vars.get("v%def.Vid", c%Cid)

inline_var
    v%def.Vid

inline_number
    %Value

inline_string
    %Value

string_expr
    %Expr

string_literal
    %stringify()



// ----------------------------------------------------------------------------------------------------------------- //
// cast and quote
// ----------------------------------------------------------------------------------------------------------------- //

cast [ %From == 'nodeset' && (%To == 'scalar' || %To == 'xml' || %To == 'attrvalue' || %To == 'boolean') ]
    yater.nodeset2%To( %Expr )

cast [ %From == 'scalar' && (%To == 'xml' || %To == 'attrvalue') ]
    yater.scalar2%To( %Expr )

// FIXME: Не бывает ли ситуации, когда таки нужно нетривиально приводить scalar к boolean?
cast [ %From == 'scalar' && %To == 'boolean' ]
    %Expr

cast
    %Expr

quote
    yater.%{Mode}Quote(%Expr)



// ----------------------------------------------------------------------------------------------------------------- //
// misc
// ----------------------------------------------------------------------------------------------------------------- //

* #yate
    %yate()


// vim: set filetype=javascript:

